# AGENTS_PLUGINS.md

> **Context:** Technical specification for building, structuring, and documenting **Tauri v2 Plugins**.
> **Target Audience:** Advanced AI Agents & Maintainers.
> **Scope:** Rust Core, Guest JS (API), Android (Kotlin), iOS (Swift), and Permissions.

## 1. The v2 Plugin Architecture
A Tauri v2 plugin is a self-contained ecosystem. It is **not** just a Rust crate; it is a hybrid package containing:
1.  **Rust Crate:** The backend logic (`/src`).
2.  **NPM Package:** The frontend API (`/guest-js`).
3.  **Mobile Bindings:** Native bridges for Android/iOS (`/android`, `/ios`).
4.  **Permissions:** Access Control Lists (ACL) (`/permissions`).

### Standard Directory Structure
The agent MUST adhere to this structure when scaffolding or modifying a plugin:

```text
tauri-plugin-[name]/
├── Cargo.toml              # Workspace definitions
├── package.json            # NPM definitions
├── src/                    # RUST: Core logic & Desktop implementation
│   ├── lib.rs              # Entry point (Builder & Mobile setup)
│   ├── desktop.rs          # Desktop-specific impl
│   ├── mobile.rs           # Mobile bridging logic
│   ├── commands.rs         # Tauri Commands (#[tauri::command])
│   └── models.rs           # Shared structs
├── guest-js/               # JAVASCRIPT: Frontend API wrapper
│   ├── index.ts            # Exports
│   └── api.ts              # Invoke calls
├── android/                # ANDROID: Kotlin implementation
│   └── src/main/java/ExamplePlugin.kt
├── ios/                    # IOS: Swift implementation
│   └── Sources/ExamplePlugin.swift
└── permissions/            # ACL: Capability definitions
    ├── default.json        # Default permission set
    └── [name].json         # Granular permission
```

## 2. Implementation Strategy

### A. The Naming Convention
* **Crate Name:** `tauri-plugin-[name]`
* **NPM Name:** `@tauri-apps/plugin-[name]`
* **Rust Method:** `init()` (in `lib.rs`)

### B. Rust Core (`src/lib.rs`)
The `Builder` pattern is mandatory.
```rust
use tauri::{
    plugin::{Builder, TauriPlugin},
    Manager, Runtime,
};

pub fn init<R: Runtime>() -> TauriPlugin<R> {
    Builder::new("[name]")
        .invoke_handler(tauri::generate_handler![commands::my_command])
        .setup(|app, api| {
            #[cfg(mobile)]
            let plugin = mobile::init(app, api)?;
            #[cfg(desktop)]
            let plugin = desktop::init(app, api)?;
            
            app.manage(plugin);
            Ok(())
        })
        .build()
}
```

### C. Mobile Bridging
Tauri v2 uses a unified bridge.
* **Rust (`mobile.rs`):** Must implement a trait that defines the plugin API.
* **Android (`ExamplePlugin.kt`):**
    * Must inherit `Plugin(activity)`.
    * Methods annotated with `@Command` are accessible to Rust.
    * *Constraint:* Arguments are received as `Invoke`.
* **iOS (`ExamplePlugin.swift`):**
    * Must inherit `Plugin`.
    * Methods must be exposed to the Obj-C runtime.

### D. Guest JS (`guest-js/index.ts`)
Do not expose raw `invoke` calls to the user. Wrap them in typed functions.
```typescript
import { invoke } from '@tauri-apps/api/core'

export async function myCommand(payload: string): Promise<string> {
    // Note the target format: plugin:[plugin-name]|[command]
    return await invoke('plugin:[name]|my_command', { payload })
}
```

## 3. Permissions System (Critical)
In Tauri v2, plugins **cannot** be used unless permissions are defined.

1.  **Define Capabilities:** Create `permissions/autogenerated/reference.toml` (or let the build script do it) to define what commands exist.
2.  **Set Defaults:** Create `permissions/default.json`.
    ```json
    {
      "$schema": "../../schemas/schema.json",
      "default": ["allow-my-command"]
    }
    ```
3.  **Documentation:** The agent must ensure `permissions/` files are committed. Without them, the consumer app cannot compile the ACL.

## 4. Build & Test Commands

| Context | Command | Notes |
| :--- | :--- | :--- |
| **Build Rust** | `cargo build` | Checks core logic. |
| **Build JS** | `pnpm build` | Compiles `guest-js` to `dist`. |
| **Lint** | `cargo clippy` | Standard Rust linting. |
| **Gen Permissions** | `cargo tauri plugin permission create` | Updates ACL definitions. |

## 5. Documentation Requirements
The agent must generate documentation for the plugin in two places:

1.  **Rustdoc (`src/*.rs`):**
    * Document the `init` function.
    * Document public configuration structs.
    * Example: `/// Initializes the [name] plugin.`
2.  **README.md (Root):**
    * **Installation:** `pnpm add @tauri-apps/plugin-[name]` + `cargo add tauri-plugin-[name]`.
    * **Usage:** Rust registration (`.plugin(tauri_plugin_name::init())`).
    * **Permissions:** Explicitly list which capabilities need to be added to the user's `capabilities/main.json`.
